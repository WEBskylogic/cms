(function(exports,undefined){"use strict";var modules={};function require(ids,callback){var module,defs=[];for(var i=0;i<ids.length;++i){module=modules[ids[i]]||resolve(ids[i]);if(!module){throw"module definition dependecy not found: "+ids[i]}defs.push(module)}callback.apply(null,defs)}function define(id,dependencies,definition){if(typeof id!=="string"){throw"invalid module definition, module id must be defined and be a string"}if(dependencies===undefined){throw"invalid module definition, dependencies must be specified"}if(definition===undefined){throw"invalid module definition, definition function must be specified"}require(dependencies,function(){modules[id]=definition.apply(null,arguments)})}function defined(id){return!!modules[id]}function resolve(id){var target=exports;var fragments=id.split(/[.\/]/);for(var fi=0;fi<fragments.length;++fi){if(!target[fragments[fi]]){return}target=target[fragments[fi]]}return target}function expose(ids){for(var i=0;i<ids.length;i++){var target=exports;var id=ids[i];var fragments=id.split(/[.\/]/);for(var fi=0;fi<fragments.length-1;++fi){if(target[fragments[fi]]===undefined){target[fragments[fi]]={}}target=target[fragments[fi]]}target[fragments[fragments.length-1]]=modules[id]}}var __moxman_util_Loader="moxman/util/Loader",__moxman_Env="moxman/Env",__moxman_util_I18n="moxman/util/I18n",__moxman_Loader="moxman/Loader",__moxman_interop_TinyMcePlugin="moxman/interop/TinyMcePlugin";define(__moxman_util_Loader,[],function(){"use strict";var idCount=0,loadedUrls={};function noop(){}function appendToHead(node){document.getElementsByTagName("head")[0].appendChild(node)}var Loader={maxLoadTime:5,load:function(urls,loadedCallback,errorCallback){var cssFiles=urls.css||[],jsFiles=urls.js||[];function loadNextScript(){if(jsFiles.length){Loader.loadScript(jsFiles.shift(),loadNextScript,errorCallback)}else{loadNextCss()}}function loadNextCss(){if(cssFiles.length){Loader.loadCss(cssFiles.shift(),loadNextCss,errorCallback)}else{loadedCallback()}}loadNextScript()},loadScript:function(url,loadedCallback,errorCallback){var key,script;function done(){loadedUrls[url]=true;loadedCallback()}if(loadedUrls[url]){loadedCallback();return}loadedCallback=loadedCallback||noop;errorCallback=errorCallback||noop;script=document.createElement("script");script.type="text/javascript";if(typeof url=="object"){for(key in url){script.setAttribute(key,url[key])}}else{script.src=url}if("onload"in script){script.onload=done;script.onerror=errorCallback}else{script.onreadystatechange=function(){var state=script.readyState;if(state=="complete"||state=="loaded"){done()}};script.onerror=errorCallback}appendToHead(script)},loadCss:function(url,loadedCallback,errorCallback){var doc=document,link,style,startTime;function done(){loadedUrls[url]=true;loadedCallback()}if(loadedUrls[url]){loadedCallback();return}loadedCallback=loadedCallback||noop;errorCallback=errorCallback||noop;function isOldWebKit(){var webKitChunks=navigator.userAgent.match(/WebKit\/(\d*)/);return!!(webKitChunks&&webKitChunks[1]<536)}function waitForWebKitLinkLoaded(){var styleSheets=doc.styleSheets,file,i=styleSheets.length,owner;while(i--){file=styleSheets[i];owner=file.ownerNode?file.ownerNode:file.owningElement;if(owner&&owner.id===link.id){done();return}}if((new Date).getTime()-startTime<Loader.maxLoadTime*1e3){window.setTimeout(waitForWebKitLinkLoaded,0)}else{errorCallback()}}function waitForGeckoLinkLoaded(){try{var cssRules=style.sheet.cssRules;done();return cssRules}catch(ex){}if((new Date).getTime()-startTime<Loader.maxLoadTime*1e3){window.setTimeout(waitForGeckoLinkLoaded,0)}else{errorCallback()}}link=doc.createElement("link");link.rel="stylesheet";link.type="text/css";link.href=url;link.id="u"+idCount++;startTime=(new Date).getTime();if("onload"in link&&!isOldWebKit()){link.onload=done;link.onerror=errorCallback}else{if(navigator.userAgent.indexOf("Firefox")>0){style=doc.createElement("style");style.textContent='@import "'+url+'"';waitForGeckoLinkLoaded();appendToHead(style);return}else{waitForWebKitLinkLoaded()}}appendToHead(link)}};return Loader});define(__moxman_Env,[],function(){return{ie7:document.all&&!window.opera&&!document.documentMode}});define(__moxman_util_I18n,[],function(){"use strict";var itemList={};var data={};return{add:function(items){for(var name in items){itemList[name]=items[name]}},translate:function(text){if(typeof text!="string"&&text.raw){return text.raw}data[text]="";return itemList[text]||text},data:data}});define(__moxman_Loader,[__moxman_util_Loader,__moxman_Env,__moxman_util_I18n],function(ResourceLoader,Env,I18n){var exports=this||window;function loadAndRender(view){return function(settings){settings=settings||{};if(!Env.baseUrl){var scripts=document.getElementsByTagName("script");for(var i=0;i<scripts.length;i++){var src=scripts[i].src;if(/(^|\/)moxman\./.test(src)){Env.baseUrl=src.substring(0,src.lastIndexOf("/"))+"/..";break}}}function done(){moxman.Env.baseUrl=Env.baseUrl;moxman.util.JsonRpc.url=Env.baseUrl+"/api.php";moxman.ui.Control.translate=I18n.translate;moxman.ui.FloatPanel.zIndex=moxman.ui.FloatPanel.zIndex||settings.zIndex;var manager=new moxman.Manager(settings);manager.init(new moxman.views[view](manager))}if(!moxman.ui){ResourceLoader.load({js:[Env.baseUrl+"/js/moxman.api.min.js",Env.baseUrl+"/api.php?action=language"+(settings.code?"&code="+settings.code:""),Env.baseUrl+"/api.php?action=PluginJs"],css:[Env.baseUrl+"/skins/lightgray/skin"+(Env.ie7?".ie7":"")+".min.css"]},done)}else{done()}}}var Loader={browse:loadAndRender("FileListView"),upload:loadAndRender("UploadView"),edit:loadAndRender("EditView"),zip:loadAndRender("ZipView"),createDir:loadAndRender("CreateDirView"),createDoc:loadAndRender("CreateDocView"),view:loadAndRender("GalleryView"),rename:loadAndRender("RenameView")};exports.moxman=exports.moxman||{};for(var name in Loader){exports.moxman[name]=Loader[name]}exports.moxman.addI18n=I18n.add;return Loader});define(__moxman_interop_TinyMcePlugin,[__moxman_Loader,__moxman_Env],function(Loader,Env){tinymce.PluginManager.add("moxiecut",function(editor,url){Env.baseUrl=url;editor.settings.file_browser_callback=function(id,value,type,win){Loader.browse({zIndex:editor.windowManager.zIndex||tinymce.ui.FloatPanel&&tinymce.ui.FloatPanel.currentZIndex,url:editor.documentBaseURI.toAbsolute(value),view:type=="image"?"thumbs":"files",oninsert:function(args){var fieldElm=win.document.getElementById(id);fieldElm.value=editor.convertURL(args.focusedFile.meta.url,null,true);if("fireEvent"in fieldElm){fieldElm.fireEvent("onchange")}else{var evt=document.createEvent("HTMLEvents");evt.initEvent("change",false,true);fieldElm.dispatchEvent(evt)}}})};function replace(template,data,escapeFuncs){if(typeof template!="string"){return template(data,escapeFuncs)}function resolve(data,path){var i,res;for(i=0,res=data,path=path.split(".");i<path.length;i++){res=res[path[i]]}return res}template=""+template.replace(/\{\$([^\}]+)\}/g,function(match,variableName){var i,parts=variableName.split("|"),value=resolve(data,parts[0]);if(typeof value=="undefined"){return""}if(parts.length==1&&escapeFuncs&&escapeFuncs.xmlEncode){value=escapeFuncs.xmlEncode(value)}for(i=1;i<parts.length;i++){value=escapeFuncs[parts[i]](value,data,variableName)}return value});template=template.replace(/\{\=([\w]+)([^\}]+)\}/g,function(match,funcName,args){return resolve(escapeFuncs,funcName)(data,funcName,args)});return template}editor.addCommand("mceInsertFile",function(ui,value){var settings={},selection=editor.selection,lastRng;lastRng=selection.getRng();tinymce.each(editor.settings,function(value,key){if(key.indexOf("moxiecut_")===0){settings[key.substring(13)]=value}});function processTemplate(template,file){return replace(template,file,{urlencode:function(value){return encodeURIComponent(value)},xmlEncode:function(value){return tinymce.DOM.encode(value)},sizeSuffix:function(value){if(value==-1){return""}if(value>1048576){return Math.round(value/1048576,1)+" MB"}if(value>1024){return Math.round(value/1024,1)+" KB"}return value+" b"}})}Loader.browse(tinymce.extend(settings,{zIndex:editor.windowManager.zIndex,view:editor.getParam("moxiecut_default_view","files"),oninsert:function(args){var html="";tinymce.each(args.files,function(file,i){var isImage=/\.(gif|jpe?g|png)$/i.test(file.name);selection.setRng(lastRng);if(!isImage&&!selection.isCollapsed()){editor.execCommand("mceInsertLink",file.meta.url);return false}if(i>0){html+=" "}if(isImage){html+=processTemplate(editor.getParam("moxiecut_image_template",'<img src="{$meta.url}" '+'width="{$meta.width}" height="{$meta.height}">'),file)}else{html+=processTemplate(editor.getParam("moxiecut_file_template",'<a href="{$url}">{$name}</a>'),file)}});selection.setRng(lastRng);editor.execCommand("mceInsertContent",false,html)}},value))});if(tinymce.Env){editor.addButton("insertfile",{icon:"browse",title:"Insert file",cmd:"mceInsertFile"})}else{editor.addButton("insertfile",{image:url+"/skins/lightgray/img/insertfile.gif",title:editor.getLang("moxiecut_insert","Insert file"),cmd:"mceInsertFile"})}});var langCode=tinymce.settings?tinymce.settings.language:"auto";if(langCode&&langCode!="en"){tinymce.ScriptLoader.load((tinymce.PluginManager.urls.moxiecut||tinymce.baseURL+"/plugins/moxiecut")+"/api.php?action=language&tinymce=true&code="+langCode)}});expose([__moxman_util_Loader,__moxman_Env,__moxman_util_I18n,__moxman_Loader,__moxman_interop_TinyMcePlugin])})(this);